---
title: "CBS: select diagnoses"
output: html_notebook
authors: Lisette de Schipper
date: 26-06-2024
description: an example on how to efficiently select diagnoses.
---

Hopefully, in your project, someone has ran the cbs_save_diagnoses_to_parquet() function to convert all those files to parquet files. If not, run it yourself :)! 

The steps are simple:
1. make a selection on the codelist provided by CBS
2. merge that codelist with the vektis files
3. have a nice cup of tea 

In this specific example we care about heart failures and related conditions.

```{r}
library(readxl) #to load in excel files
library(data.table) #not required, but personal preference. Everything done here could have been done on a data frame as well :)
library(dplyr)

setwd(dirname(rstudioapi::getActiveDocumentContext()$path))

source("cbs_get_gen_parquet_files.R") # quick and easy way to get the files generated by cbs_get_diagnoses()

```

```{r}
diag_file = r"(K:\GezondheidWelzijn\MSZPRESTATIESVEKTTAB\codelijst variabeleVEKTMSZSpecialismeDiagnoseCombinatie.xlsx)";

diag_df <- setDT(read_xlsx(diag_file, 
                           col_names = c("VEKTMSZSpecialismeDiagnoseCombinatie", "Diagnosis"),
                           skip = 1))

diag_df <- diag_df %>% mutate(across(c(VEKTMSZSpecialismeDiagnoseCombinatie, Diagnosis), ~gsub("\"" ,"", .x)))
```

We want to add the column "Setting" for every row, and add labels 1,2,3 and 9.
id| meaning
___
1 | policlinical
2 | day treatment
3 | clinical
9 | missing
```{r}
setting <- c(c(1,2,3,9))
diag_df <- diag_df[, setting, names(diag_df)]
diag_df
```


The data set is small, so you can just go through them, look for keywords. Select whatever strikes your fancy
```{r}
selection_df <- diag_df

selection_df[Diagnosis %ilike% c("TIA"), TIA := 1]
selection_df[Diagnosis %ilike% c("hartfalen"), heartfailure := 1]
selection_df[Diagnosis %ilike% c("hartinfarct") & setting == 3, MI := 1]
selection_df[VEKTMSZSpecialismeDiagnoseCombinatie == "0320-04-00-0401", AF := 1]

# ... you get the drill. You could also use the dplyr library instead. Whatever floats your boat.

selection_df <- selection_df %>% mutate(
  CVA = ifelse(((Diagnosis %ilike% "Onbloedige beroerte" ) | (Diagnosis %ilike% "Intracerebrale bloeding"))
               & setting == 3, 1, 0))

# Be mindful of your conditionals: if you would have typed the following, you would have overwritten the first conditional with the second one:
# selection_df <- selection_df %>% mutate(
#   CVA = ifelse(Diagnosis %ilike% "Intracerebrale bloeding" & setting == 3, 1, 0),
#   CVA = ifelse(Diagnosis %ilike% "Onbloedige beroerte" & setting == 3, 1, 0))


```

So, we've coded our diseases into their own columns. Time for the grand finale!

Let's get the diagnoses.

```{r}
diagnoses <- setDT(get_parquet_files(r"(H:\lisette\R\parquet)", "Diagnoses", 2016))
```
Time to merge

```{r}
#Note that you could, potentially, drop the "diagnosis" table from the diagnoses data table before the merge!
diagnoses[, setting := as.integer(VEKTMSZSettingZPK)]
diagnoses <- merge(diagnoses, selection_df, all.x = TRUE, by = c("RINPERSOONS", "RINPERSOON"))
```

